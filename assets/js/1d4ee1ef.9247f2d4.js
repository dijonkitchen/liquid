"use strict";(self.webpackChunkliquid_docs=self.webpackChunkliquid_docs||[]).push([[5187],{5912:function(e,a,n){n.r(a),n.d(a,{assets:function(){return m},contentTitle:function(){return p},default:function(){return c},frontMatter:function(){return o},metadata:function(){return s},toc:function(){return u}});var t=n(3117),l=n(102),i=(n(7294),n(3905)),r=["components"],o={},p="Static Template Analysis",s={unversionedId:"guides/static-template-analysis",id:"guides/static-template-analysis",title:"Static Template Analysis",description:"_New in version 1.2.0_",source:"@site/docs/guides/static-template-analysis.md",sourceDirName:"guides",slug:"/guides/static-template-analysis",permalink:"/liquid/guides/static-template-analysis",draft:!1,editUrl:"https://github.com/jg-rp/liquid/tree/docs/docs/guides/static-template-analysis.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"Security",permalink:"/liquid/guides/security"},next:{title:"Contextual Template Analysis",permalink:"/liquid/guides/contextual-template-analysis"}},m={},u=[{value:"All Template Variables",id:"all-template-variables",level:2},{value:"Global Template Variables",id:"global-template-variables",level:2},{value:"Local Template Variables",id:"local-template-variables",level:2},{value:"Analyzing Partial Templates",id:"analyzing-partial-templates",level:2},{value:"Analyzing Custom Tags",id:"analyzing-custom-tags",level:2}],d={toc:u};function c(e){var a=e.components,n=(0,l.Z)(e,r);return(0,i.kt)("wrapper",(0,t.Z)({},d,n,{components:a,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"static-template-analysis"},"Static Template Analysis"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},(0,i.kt)("em",{parentName:"strong"},"New in version 1.2.0"))),(0,i.kt)("p",null,"Use the ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/BoundTemplate#analyze"},(0,i.kt)("inlineCode",{parentName:"a"},"analyze()"))," or ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/BoundTemplate#analyze_async"},(0,i.kt)("inlineCode",{parentName:"a"},"analyze_async()"))," methods of a Liquid ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/BoundTemplate"},(0,i.kt)("inlineCode",{parentName:"a"},"Template"))," to traverse its abstract syntax tree and report template variable usage."),(0,i.kt)("h2",{id:"all-template-variables"},"All Template Variables"),(0,i.kt)("p",null,"The object returned from ",(0,i.kt)("inlineCode",{parentName:"p"},"analyze()")," is an instance of ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/template-analysis"},(0,i.kt)("inlineCode",{parentName:"a"},"TemplateAnalysis")),". Its ",(0,i.kt)("inlineCode",{parentName:"p"},"variables")," property is a dictionary mapping template variable names to a list of two-tuples. Each tuple is the template name and line number where the variable was found."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from liquid import Template\n\ntemplate = Template("""\\\n{% assign people = "Sally, John, Brian, Sue" | split: ", " %}\n{{ people }}\n{% for name in people %}\n    {{ forloop.index }} - {{ greeting }}, {{ name }}!\n{% endfor %}\n""")\n\nanalysis = template.analyze()\nprint(list(analysis.variables))\n\nfor name, location in analysis.variables.items():\n    for template_name, line_number in location:\n        print(f"\'{name}\' found in \'{template_name}\' on line {line_number}")\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-plain",metastring:'title="output"',title:'"output"'},"['people', 'forloop.index', 'greeting', 'name']\n'people' found in '<string>' on line 2\n'people' found in '<string>' on line 3\n'forloop.index' found in '<string>' on line 4\n'greeting' found in '<string>' on line 4\n'name' found in '<string>' on line 4\n")),(0,i.kt)("h2",{id:"global-template-variables"},"Global Template Variables"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"global_variables")," property of ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/template-analysis"},(0,i.kt)("inlineCode",{parentName:"a"},"TemplateAnalysis"))," is similar to ",(0,i.kt)("inlineCode",{parentName:"p"},"variables"),", but only includes those variables that are not in scope from previous ",(0,i.kt)("inlineCode",{parentName:"p"},"assign")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"capture")," tags, or added to a block's scope by a block tag."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from liquid import Template\n\ntemplate = Template("""\\\n{% assign people = "Sally, John, Brian, Sue" | split: ", " %}\n{{ people }}\n{% for name in people %}\n    {{ forloop.index }} - {{ greeting }}, {{ name }}!\n{% endfor %}\n""")\n\nanalysis = template.analyze()\nprint("all variables: ", list(analysis.variables))\nprint("global variables: ", list(analysis.global_variables))\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-plain",metastring:'title="output"',title:'"output"'},"all variables:  ['people', 'forloop.index', 'greeting', 'name']\nglobal variables:  ['greeting']\n")),(0,i.kt)("p",null,"While ",(0,i.kt)("inlineCode",{parentName:"p"},"greeting")," is assumed to be global (that is, provided by application developers rather than a template author), Python Liquid knows that ",(0,i.kt)("inlineCode",{parentName:"p"},"forloop")," is in scope for the duration of the ",(0,i.kt)("inlineCode",{parentName:"p"},"for")," block. If ",(0,i.kt)("inlineCode",{parentName:"p"},"people")," were referenced before being assigned, we'd see an entry in the ",(0,i.kt)("inlineCode",{parentName:"p"},"people")," list for each location where it is out of scope."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from liquid import Template\n\ntemplate = Template("""\\\n{{ people }}\n{% assign people = "Sally, John, Brian, Sue" | split: ", " %}\n{{ people }}\n""")\n\nanalysis = template.analyze()\n\nfor name, location in analysis.global_variables.items():\n    for template_name, line_number in location:\n        print(f"\'{name}\' is out of scope in \'{template_name}\' on line {line_number}")\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-plain",metastring:'title="output"',title:'"output"'},"'people' is out of scope in '<string>' on line 1\n")),(0,i.kt)("h2",{id:"local-template-variables"},"Local Template Variables"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"local_variables")," property of ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/template-analysis"},(0,i.kt)("inlineCode",{parentName:"a"},"TemplateAnalysis"))," is, again, a dictionary mapping template variable names to their locations. Each entry is the location of an ",(0,i.kt)("inlineCode",{parentName:"p"},"assign"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"capture"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"increment"),", or ",(0,i.kt)("inlineCode",{parentName:"p"},"decrement")," tag (or any custom tag that introduces names into the template local namespace) that initializes or updates the variable."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from liquid import Template\n\ntemplate = Template("""\\\n{% assign people = "Sally, John, Brian, Sue" | split: ", " %}\n{% assign people = "Bob, Frank" | split: ", " %}\n""")\n\nanalysis = template.analyze()\n\nfor name, location in analysis.local_variables.items():\n    for template_name, line_number in location:\n        print(f"\'{name}\' assigned in \'{template_name}\' on line {line_number}")\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-plain",metastring:'title="output"',title:'"output"'},"'people' assigned in '<string>' on line 1\n'people' assigned in '<string>' on line 2\n")),(0,i.kt)("h2",{id:"analyzing-partial-templates"},"Analyzing Partial Templates"),(0,i.kt)("p",null,"When the ",(0,i.kt)("inlineCode",{parentName:"p"},"follow_partials")," argument to ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/BoundTemplate#analyze"},(0,i.kt)("inlineCode",{parentName:"a"},"BoundTemplate.analyze()"))," is ",(0,i.kt)("inlineCode",{parentName:"p"},"True")," (the default), Python Liquid will attempt to load and analyze templates from ",(0,i.kt)("inlineCode",{parentName:"p"},"include")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"render")," tags. In the case of ",(0,i.kt)("inlineCode",{parentName:"p"},"include"),", this is only possible when the template name is a string literal."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from pprint import pprint\nfrom liquid import Environment, DictLoader\n\ntemplates = {\n    "layout": """\\\n        {% include \'nav\', title: page_name %}\n        {% render \'foot\' with website as site_name %}\n    """,\n    "nav": "{{ title }} nav bar",\n    "foot": "a footer for {{ site_name }}",\n}\n\nenv = Environment(loader=DictLoader(templates))\nlayout = env.get_template("layout")\n\nanalysis = layout.analyze(follow_partials=True)\npprint(analysis.variables)\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-plain",metastring:'title="output"',title:'"output"'},"{'page_name': [('layout', 1)],\n 'site_name': [('foot', 1)],\n 'title': [('nav', 1)],\n 'website': [('layout', 2)]}\n")),(0,i.kt)("p",null,"When the ",(0,i.kt)("inlineCode",{parentName:"p"},"raise_for_failures")," argument is ",(0,i.kt)("inlineCode",{parentName:"p"},"True")," (the default), we should expect a ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/exceptions#templatetraversalerror"},(0,i.kt)("inlineCode",{parentName:"a"},"TemplateTraversalError"))," to be raised if a partial template can not be loaded. If ",(0,i.kt)("inlineCode",{parentName:"p"},"raise_for_failures")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"False"),", a dictionary of unloadable ",(0,i.kt)("inlineCode",{parentName:"p"},"include"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"render")," tags is available as ",(0,i.kt)("inlineCode",{parentName:"p"},"TemplateAnalysis.unloadable_partials"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from liquid import Environment, DictLoader\n\ntemplates = {\n    "layout": """\\\n        {% include \'nav\', title: page_name %}\n        {% render \'foot\' with website as site_name %}\n    """,\n}\n\nenv = Environment(loader=DictLoader(templates))\nlayout = env.get_template("layout")\n\nanalysis = layout.analyze(follow_partials=True, raise_for_failures=False)\nprint(analysis.unloadable_partials)\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-plain",metastring:"title=output",title:"output"},"{'foot': [('layout', 2)], 'nav': [('layout', 1)]}\n")),(0,i.kt)("h2",{id:"analyzing-custom-tags"},"Analyzing Custom Tags"),(0,i.kt)("p",null,"All built-in tags (the tag's ",(0,i.kt)("inlineCode",{parentName:"p"},"Node")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Expression")," classes) implement a ",(0,i.kt)("inlineCode",{parentName:"p"},"children()")," method. When analyzing a custom tag that does not implement ",(0,i.kt)("inlineCode",{parentName:"p"},"children()"),", and with the ",(0,i.kt)("inlineCode",{parentName:"p"},"raise_for_failures")," argument set to ",(0,i.kt)("inlineCode",{parentName:"p"},"True")," (the default), Python Liquid will raise a ",(0,i.kt)("a",{parentName:"p",href:"/liquid/api/exceptions#templatetraversalerror"},(0,i.kt)("inlineCode",{parentName:"a"},"TemplateTraversalError")),". When ",(0,i.kt)("inlineCode",{parentName:"p"},"raise_for_failures")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"False"),", a dictionary of unvisitable AST nodes and expressions is available as ",(0,i.kt)("inlineCode",{parentName:"p"},"TemplateAnalysis.failed_visits"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'from liquid import Environment, DictLoader\nfrom liquid.ast import Node\nfrom liquid.tag import Tag\n\nclass ExampleNode(Node):\n    def __init__(self, token: Token) -> None:\n        self.tok = token\n\n    def render_to_output(self, context: Context, buffer: TextIO) -> Optional[bool]:\n        buffer.write("example node")\n\n    async def render_to_output_async(\n        self, context: Context, buffer: TextIO\n    ) -> Optional[bool]:\n        buffer.write("example node")\n\n\nclass ExampleTag(Tag):\n    block = False\n    name = "example"\n\n    def parse(self, stream: TokenStream) -> Node:\n        return ExampleNode(stream.current)\n\n\ntemplates = {\n    "layout": "{% example %}"\n}\n\nenv = Environment(loader=DictLoader(templates))\nenv.add_tag(ExampleTag)\nlayout = env.get_template("layout")\n\nanalysis = layout.analyze(follow_partials=True, raise_for_failures=False)\nprint(analysis.failed_visits)\n')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-plain",metastring:"title=output",title:"output"},"{'ExampleNode': [('layout', 1)]}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"liquid.ast.Node.children()")," should return a list of ",(0,i.kt)("inlineCode",{parentName:"p"},"liquid.ast.ChildNode")," objects. Each ",(0,i.kt)("inlineCode",{parentName:"p"},"ChildNode")," includes a child ",(0,i.kt)("inlineCode",{parentName:"p"},"Expression")," and/or ",(0,i.kt)("inlineCode",{parentName:"p"},"Node"),", plus any names the tag adds to the template local scope or subsequent block scope. Please see ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/jg-rp/liquid/tree/main/liquid/builtin/tags"},"liquid/builtin/tags")," for examples."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"liquid.expression.Expression.children()")," is expected to return a list of child ",(0,i.kt)("inlineCode",{parentName:"p"},"Expressions"),". For example, ",(0,i.kt)("inlineCode",{parentName:"p"},"liquid.expression.RangeLiteral")," returns a list containing expressions for its ",(0,i.kt)("inlineCode",{parentName:"p"},"start")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"stop")," properties. Please see ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/jg-rp/liquid/blob/main/liquid/expression.py"},"liquid/expression.py")," for examples."))}c.isMDXComponent=!0},3905:function(e,a,n){n.d(a,{Zo:function(){return m},kt:function(){return c}});var t=n(7294);function l(e,a,n){return a in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}function i(e,a){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);a&&(t=t.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),n.push.apply(n,t)}return n}function r(e){for(var a=1;a<arguments.length;a++){var n=null!=arguments[a]?arguments[a]:{};a%2?i(Object(n),!0).forEach((function(a){l(e,a,n[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))}))}return e}function o(e,a){if(null==e)return{};var n,t,l=function(e,a){if(null==e)return{};var n,t,l={},i=Object.keys(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||(l[n]=e[n]);return l}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(t=0;t<i.length;t++)n=i[t],a.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var p=t.createContext({}),s=function(e){var a=t.useContext(p),n=a;return e&&(n="function"==typeof e?e(a):r(r({},a),e)),n},m=function(e){var a=s(e.components);return t.createElement(p.Provider,{value:a},e.children)},u={inlineCode:"code",wrapper:function(e){var a=e.children;return t.createElement(t.Fragment,{},a)}},d=t.forwardRef((function(e,a){var n=e.components,l=e.mdxType,i=e.originalType,p=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),d=s(n),c=l,f=d["".concat(p,".").concat(c)]||d[c]||u[c]||i;return n?t.createElement(f,r(r({ref:a},m),{},{components:n})):t.createElement(f,r({ref:a},m))}));function c(e,a){var n=arguments,l=a&&a.mdxType;if("string"==typeof e||l){var i=n.length,r=new Array(i);r[0]=d;var o={};for(var p in a)hasOwnProperty.call(a,p)&&(o[p]=a[p]);o.originalType=e,o.mdxType="string"==typeof e?e:l,r[1]=o;for(var s=2;s<i;s++)r[s]=n[s];return t.createElement.apply(null,r)}return t.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);